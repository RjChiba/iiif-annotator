# IIIF テキスト文字起こしアノテーションツール 機能要件定義書

## 1. プロジェクト概要

IIIF Presentation API v3 で提供される manifest に対して、テキスト文字起こしアノテーションを付与・編集できる Web ベースのアプリケーション。図書・文書のデジタルアーカイブ支援を目的とする。

## 2. 技術前提

| 項目 | 仕様 |
|------|------|
| IIIF Presentation API | v3 のみ対応 |
| アノテーション形式 | W3C Web Annotation Model |
| Motivation | `supplementing`（文字起こし用途） |
| ターゲット指定 | Canvas URI + メディアフラグメント `#xywh=x,y,w,h` |
| テキスト形式 | `TextualBody`（`text/plain`） |
| 画像表示 | OpenSeadragon 等によるディープズーム |
| データ保存 | ブラウザローカル（LocalStorage）のみ、サーバー不要 |

---

## 3. 機能要件

### 3.1 Manifest 読み込み

#### 3.1.1 URL からの読み込み

- ユーザーが入力フォームに IIIF manifest の URL を入力して読み込むことができる
- CORS エラーが発生した場合、ユーザーに分かりやすいエラーメッセージを表示する
- 読み込み中はローディング表示を行う

#### 3.1.2 ファイルアップロードからの読み込み

- ローカルの `manifest.json` ファイルをファイル選択ダイアログまたはドラッグ＆ドロップで読み込むことができる
- JSON のパースエラーや IIIF v3 非準拠の場合はエラーを表示する

#### 3.1.3 既存アノテーションの読み込み

- manifest 内に既存の `AnnotationPage`（`motivation: supplementing`）が含まれる場合、それを読み込んでエディタ上に表示する
- 読み込んだアノテーションは編集・削除が可能

---

### 3.2 画像表示・ビューア

- OpenSeadragon（または同等のライブラリ）を使用したディープズームビューアを実装する
- IIIF Image API に対応しており、タイル分割による高解像度画像の表示に対応する
- マウスホイール / ピンチでズームイン・アウトができる
- ドラッグ（パン）で画像内を移動できる
- ズームリセットボタン（全体表示に戻る）を提供する

---

### 3.3 ページ（Canvas）ナビゲーション

#### 3.3.1 サムネイル一覧パネル

- 画面左サイドに Canvas のサムネイル一覧を表示する
- サムネイルをクリックすると該当 Canvas に移動する
- 現在表示中の Canvas はハイライト表示する
- サムネイルには Canvas のラベルとページ番号を表示する

#### 3.3.2 前後ナビゲーション

- 前のページ・次のページボタンで順番に Canvas を移動できる
- 現在のページ番号と総ページ数を表示する（例：`3 / 120`）
- キーボードショートカット（← →）でも移動できる

---

### 3.4 アノテーション作成

- ビューア上でマウスドラッグにより矩形（Bounding Box）を描画してアノテーションを作成する
- 描画モードと閲覧モードを UI で切り替えられる（例：ツールバーのボタン）
- 矩形描画完了後、テキスト入力パネルが自動で開く
- テキストを入力せずに確定した場合（空テキスト）、アノテーションは自動的に破棄する
- 1 つの Canvas に複数のアノテーションを追加できる

---

### 3.5 アノテーション編集

#### 3.5.1 矩形の操作

- アノテーションの矩形をドラッグして位置を移動できる
- 矩形の角・辺のハンドルをドラッグしてリサイズできる
- 選択中のアノテーションはビューア上でハイライト表示する
- 複数のアノテーション矩形が重なるクリック位置では、作成順が新しい（ID が大きい）アノテーションを優先的に選択する（詳細は今後検討・更新）

#### 3.5.2 テキストの編集

- アノテーションをクリックすると右パネルにテキスト入力エリアが表示される
- テキストを編集して保存できる

#### 3.5.3 言語属性の設定

- テキスト入力エリアに言語コード（`xml:lang`）を指定する入力欄を設ける（例：`ja`、`en`）
- デフォルト言語を設定できる（アプリ設定として保持）

#### 3.5.4 アノテーションの削除

- 選択中のアノテーションを削除するボタンを提供する
- 削除前に確認ダイアログを表示する

---

### 3.6 アノテーション一覧

- 現在の Canvas に存在するアノテーションの一覧を右パネルに表示する
- 一覧の各アイテムをクリックすると該当アノテーションが選択される（ビューアもハイライト）
- アノテーションはビューア上の矩形の Y 座標順（上から下）に並べて表示する
- 一覧からもテキストをプレビュー表示する（先頭 N 文字程度）

---

### 3.7 作業データの一時保存（ローカル）

- 作業中のアノテーションデータをブラウザの LocalStorage に自動保存する
- ブラウザを閉じて再度開いた際に、前回の作業状態を復元できる
- manifest URL またはファイル名をキーとして保存データを管理する
- 保存データをクリアするボタンを設ける

---

### 3.8 アノテーションのエクスポート

#### 3.8.1 出力形式

- IIIF Presentation API v3 準拠の `AnnotationPage` を JSON-LD 形式で出力する
- Canvas ごとに 1 つの `AnnotationPage` ファイルを生成する（Canvas 数分のファイル）
- または全 Canvas 分をまとめた ZIP ファイルとしてダウンロードできる

#### 3.8.2 AnnotationPage のスキーマ

- `AnnotationPage` および各 `Annotation` の `id` は UUID v4 を用いたダミー URI を自動生成する（例：`urn:uuid:xxxxxxxx-...`）
- 一般公開時の URI 設計は別途検討する

```json
{
  "@context": "http://iiif.io/api/presentation/3/context.json",
  "id": "urn:uuid:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "type": "AnnotationPage",
  "items": [
    {
      "id": "urn:uuid:yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
      "type": "Annotation",
      "motivation": "supplementing",
      "body": {
        "type": "TextualBody",
        "value": "文字起こしテキスト",
        "format": "text/plain",
        "language": "ja"
      },
      "target": "https://example.org/canvas/1#xywh=100,200,300,50"
    }
  ]
}
```

#### 3.8.3 ダウンロード操作

- エクスポートボタンから以下のオプションを提供する
  - 現在の Canvas の AnnotationPage のみダウンロード
  - 全 Canvas 分をまとめた ZIP ダウンロード
- ファイル名は Canvas の ID または順番を元に自動付与する

---

## 4. 画面レイアウト（概略）

```
+------------------+----------------------------------+-------------------+
|                  |  ツールバー（描画モード切替・ズームリセット等）         |                   |
|  サムネイル      +----------------------------------+  アノテーション    |
|  一覧パネル      |                                  |  一覧パネル        |
|                  |                                  |                   |
|  [Canvas 1]      |     OpenSeadragon ビューア       |  [anno 1] テキスト |
|  [Canvas 2]  ◀  |     （画像 + アノテーション矩形） |  [anno 2] テキスト |
|  [Canvas 3]      |                                  |  ...               |
|  ...             |                                  +-------------------+
|                  |                                  |  テキスト編集エリア|
|                  +----------------------------------+  言語コード入力   |
|                  |  ← 前のページ  3 / 120  次のページ→ |  [保存] [削除]    |
+------------------+----------------------------------+-------------------+
```

---

## 5. 非機能要件

| 項目 | 内容 |
|------|------|
| 動作環境 | モダンブラウザ（Chrome / Firefox / Safari / Edge 最新版） |
| サーバー不要 | 静的ファイルのみで動作（SPA） |
| オフライン対応 | 画像は外部サーバー依存だが、アプリ本体は静的配信で動作 |
| アクセシビリティ | キーボード操作による基本機能の利用 |
| レスポンシブ | デスクトップブラウザに最適化（タブレット以上推奨） |

---

## 6. 今後の検討事項

- 複数アノテーションが重なった場合の選択 UI の詳細仕様（現状：最新アノテーション優先）
- アノテーションの並べ替え（手動順序変更）の必要性
- キーボードショートカットの詳細仕様
- 一般公開時の `AnnotationPage` / `Annotation` `id` URI 設計

---

*最終更新: 2026-02-26（v0.2 — 未確定事項 3 件を確定）*
