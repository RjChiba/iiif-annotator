# IIIF テキスト文字起こしアノテーションツール 機能要件定義書

> **変更履歴（v0.2 → v0.3）**
> - `[NEW]` 新規追加
> - `[CHANGED]` 既存内容の変更
> - `[REMOVED]` 削除
> - マークなし: 変更なし

---

## 1. プロジェクト概要

IIIF Presentation API v3 で提供される manifest に対して、テキスト文字起こしアノテーションを付与・編集できる Web ベースのアプリケーション。図書・文書のデジタルアーカイブ支援を目的とする。

> [NEW] IIIF manifest のほか、画像ファイルや PDF をアップロードして IIIF manifest を自動生成する入力経路も提供する。作業データはサーバーサイドのファイルシステムに永続保存し、プロジェクト管理画面から履歴の確認・再開が可能。

---

## 2. 技術前提

| 項目 | 仕様 |
|------|------|
| IIIF Presentation API | v3 のみ対応 |
| アノテーション形式 | W3C Web Annotation Model |
| Motivation | `supplementing`（文字起こし用途） |
| ターゲット指定 | Canvas URI + メディアフラグメント `#xywh=x,y,w,h` |
| テキスト形式 | `TextualBody`（`text/plain`） |
| 画像表示 | OpenSeadragon 等によるディープズーム |
| **[CHANGED]** データ保存 | ~~ブラウザローカル（LocalStorage）のみ、サーバー不要~~ → サーバーサイドファイルシステム（`/data` ディレクトリ）+ Next.js API Routes |
| **[NEW]** PDF 変換 | PDF.js によるクライアントサイドレンダリング → PNG 変換 |
| **[NEW]** 実行環境 | Next.js サーバー必須（静的エクスポート不可） |

---

## 3. 機能要件

### **[NEW] 3.1 プロジェクト管理**

#### 3.1.1 プロジェクト一覧（ホーム画面）

- アプリ起動時にプロジェクト一覧画面を表示する
- 各プロジェクトエントリには以下を表示する
  - マニフェスト名 / ファイル名（manifest の `label` またはファイル名）
  - 作成日時
  - 最終更新日時
- エントリをクリックするとそのプロジェクトのエディタ画面を開く
- 新規プロジェクト作成ボタンを提供する
- プロジェクトの削除機能を提供する（削除前に確認ダイアログを表示する）

#### 3.1.2 プロジェクトのデータ構造

サーバーサイドは以下のディレクトリ構造でデータを管理する。

```
/data/
  projects/
    [project-uuid]/
      meta.json          # プロジェクトメタ情報（名前・日時等）
      manifest.json      # IIIF manifest（読み込み元または自動生成）
      annotations/
        [canvas-index].json  # Canvas ごとの AnnotationPage
/public/
  uploads/
    [project-uuid]/
      [filename]         # アップロード・変換された画像ファイル
```

`meta.json` のスキーマ:

```json
{
  "id": "urn:uuid:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "name": "マニフェスト名またはファイル名",
  "sourceType": "manifest-url | manifest-file | file-upload",
  "sourceRef": "読み込み元 URL またはファイル名",
  "createdAt": "2026-02-26T00:00:00.000Z",
  "updatedAt": "2026-02-26T00:00:00.000Z"
}
```

---

### **[CHANGED]** 3.2 コンテンツ読み込み（旧: 3.1 Manifest 読み込み）

新規プロジェクト作成時に、以下の 2 つの入力経路のいずれかを選択する。

#### 3.2.1 IIIF Manifest の読み込み（旧: 3.1.1 + 3.1.2 を統合）

**URL 指定による読み込み**（旧 3.1.1 より変更なし）

- ユーザーが入力フォームに IIIF manifest の URL を入力して読み込むことができる
- CORS エラーが発生した場合、ユーザーに分かりやすいエラーメッセージを表示する
- 読み込み中はローディング表示を行う

**ファイルアップロードによる読み込み**（旧 3.1.2 より変更なし）

- ローカルの `manifest.json` ファイルをファイル選択ダイアログまたはドラッグ＆ドロップで読み込むことができる
- JSON のパースエラーや IIIF v3 非準拠の場合はエラーを表示する

#### **[NEW]** 3.2.2 実ファイルのアップロード

- 対応ファイル形式: 画像（JPEG / PNG）、PDF
- ファイル選択ダイアログまたはドラッグ＆ドロップで複数ファイルを受け付ける
- アップロード後、以下を内部処理として自動実行する

**内部処理フロー**

1. **PDF の場合**: PDF.js によりクライアントサイドで各ページを PNG 画像にレンダリングする
2. **画像の保存**: 変換済み画像を `POST /api/upload` 経由でサーバーに送信し、`/public/uploads/[project-uuid]/` に保存する
4. **IIIF manifest の自動生成**: アップロードされた画像を元に IIIF Presentation API v3 準拠の manifest を生成する
   - Canvas の画像 URI はローカルサーバーの静的ファイル URL（例: `http://localhost:3000/uploads/[project-uuid]/page-1.png`）を使用する
   - ファイルの並び順はアップロード時のファイル名順（辞書順）とする
   - Canvas ラベルはファイル名から自動生成する（例: `page-001`）

> **制約事項**: 実ファイルアップロードで生成された manifest に含まれる画像 URI はローカルサーバーのパスを前提とするため、エクスポートした manifest は別環境では画像を参照できない。

#### 3.2.3 既存アノテーションの読み込み（旧 3.1.3 より変更なし）

- manifest 内に既存の `AnnotationPage`（`motivation: supplementing`）が含まれる場合、それを読み込んでエディタ上に表示する
- 読み込んだアノテーションは編集・削除が可能

---

### 3.3 画像表示・ビューア（旧: 3.2）

- OpenSeadragon（または同等のライブラリ）を使用したディープズームビューアを実装する
- IIIF Image API に対応しており、タイル分割による高解像度画像の表示に対応する
- **[NEW]** 実ファイルアップロード経由の場合は IIIF Image API を使用せず静的ファイルとして参照する
- マウスホイール / ピンチでズームイン・アウトができる
- ドラッグ（パン）で画像内を移動できる
- ズームリセットボタン（全体表示に戻る）を提供する

---

### 3.4 ページ（Canvas）ナビゲーション（旧: 3.3 — 変更なし）

#### 3.4.1 サムネイル一覧パネル

- 画面左サイドに Canvas のサムネイル一覧を表示する
- サムネイルをクリックすると該当 Canvas に移動する
- 現在表示中の Canvas はハイライト表示する
- サムネイルには Canvas のラベルとページ番号を表示する

#### 3.4.2 前後ナビゲーション

- 前のページ・次のページボタンで順番に Canvas を移動できる
- 現在のページ番号と総ページ数を表示する（例：`3 / 120`）
- キーボードショートカット（← →）でも移動できる

---

### 3.5 アノテーション作成（旧: 3.4 — 変更なし）

- ビューア上でマウスドラッグにより矩形（Bounding Box）を描画してアノテーションを作成する
- 描画モードと閲覧モードを UI で切り替えられる（例：ツールバーのボタン）
- 矩形描画完了後、テキスト入力パネルが自動で開く
- テキストを入力せずに確定した場合（空テキスト）、アノテーションは自動的に破棄する
- 1 つの Canvas に複数のアノテーションを追加できる

---

### 3.6 アノテーション編集（旧: 3.5 — 変更なし）

#### 3.6.1 矩形の操作

- アノテーションの矩形をドラッグして位置を移動できる
- 矩形の角・辺のハンドルをドラッグしてリサイズできる
- 選択中のアノテーションはビューア上でハイライト表示する
- 複数のアノテーション矩形が重なるクリック位置では、作成順が新しい（ID が大きい）アノテーションを優先的に選択する（詳細は今後検討・更新）

#### 3.6.2 テキストの編集

- アノテーションをクリックすると右パネルにテキスト入力エリアが表示される
- テキストを編集して保存できる

#### 3.6.3 言語属性の設定

- テキスト入力エリアに言語コード（`xml:lang`）を指定する入力欄を設ける（例：`ja`、`en`）
- デフォルト言語を設定できる（アプリ設定として保持）

#### 3.6.4 アノテーションの削除

- 選択中のアノテーションを削除するボタンを提供する
- 削除前に確認ダイアログを表示する

---

### 3.7 アノテーション一覧（旧: 3.6 — 変更なし）

- 現在の Canvas に存在するアノテーションの一覧を右パネルに表示する
- 一覧の各アイテムをクリックすると該当アノテーションが選択される（ビューアもハイライト）
- アノテーションはビューア上の矩形の Y 座標順（上から下）に並べて表示する
- 一覧からもテキストをプレビュー表示する（先頭 N 文字程度）

---

### **[CHANGED]** 3.8 作業データの保存（旧: 3.7 作業データの一時保存（ローカル））

> 旧仕様（LocalStorage）から**サーバーサイドファイルシステムへの永続保存**に変更。

- アノテーション操作後に自動保存を行う（`PUT /api/projects/[id]/annotations` への API 呼び出し）
- サーバーサイドの `/data/projects/[project-uuid]/annotations/[canvas-index].json` に AnnotationPage 形式で保存する
- **[REMOVED]** ~~ブラウザの LocalStorage に自動保存する~~
- **[REMOVED]** ~~ブラウザを閉じて再度開いた際に、前回の作業状態を復元できる~~
- **[REMOVED]** ~~manifest URL またはファイル名をキーとして保存データを管理する~~
- プロジェクト一覧画面（3.1.1）からサーバー側の保存データを選択して作業を再開できる
- プロジェクトの削除はプロジェクト一覧画面から行う（対応する画像ファイルも合わせて削除する）
- **[REMOVED]** ~~保存データをクリアするボタンを設ける~~ → プロジェクト削除機能に統合（3.1.1）

---

### **[CHANGED]** 3.9 アノテーションのエクスポート（旧: 3.8）

#### **[CHANGED]** 3.9.1 出力形式（旧 3.8.1）

> 旧仕様ではアノテーションを Canvas ごとの AnnotationPage として別ファイル出力・ZIP 化していたが、**アノテーション埋め込み済み manifest の単一 JSON ダウンロード**に統一する。

- アノテーションを付与済みの IIIF Presentation API v3 準拠の manifest を JSON-LD 形式でエクスポートする
- manifest の `annotations` フィールドに各 Canvas の `AnnotationPage` を埋め込んだ単一 JSON ファイルとして出力する
- **[REMOVED]** ~~Canvas ごとに 1 つの AnnotationPage ファイルを生成する~~
- **[REMOVED]** ~~全 Canvas 分をまとめた ZIP ファイルとしてダウンロードできる~~

#### 3.9.2 AnnotationPage のスキーマ（変更なし）

- `AnnotationPage` および各 `Annotation` の `id` は UUID v4 を用いたダミー URI を自動生成する（例：`urn:uuid:xxxxxxxx-...`）
- 一般公開時の URI 設計は別途検討する

```json
{
  "@context": "http://iiif.io/api/presentation/3/context.json",
  "id": "urn:uuid:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "type": "AnnotationPage",
  "items": [
    {
      "id": "urn:uuid:yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",
      "type": "Annotation",
      "motivation": "supplementing",
      "body": {
        "type": "TextualBody",
        "value": "文字起こしテキスト",
        "format": "text/plain",
        "language": "ja"
      },
      "target": "https://example.org/canvas/1#xywh=100,200,300,50"
    }
  ]
}
```

#### **[CHANGED]** 3.9.3 ダウンロード操作（旧 3.8.3）

- エクスポートボタンからアノテーション埋め込み済み manifest JSON をダウンロードできる
- ファイル名はプロジェクト名または manifest ラベルを元に自動付与する
- **[REMOVED]** ~~現在の Canvas の AnnotationPage のみダウンロード~~
- **[REMOVED]** ~~全 Canvas 分をまとめた ZIP ダウンロード~~

---

## 4. 画面レイアウト（概略）

### **[NEW]** 4.1 プロジェクト一覧（ホーム）

```
+----------------------------------------------------------+
|  IIIF アノテーションツール          [新規プロジェクト作成] |
+----------------------------------------------------------+
|  プロジェクト一覧                                         |
|  +----------------------------------------------------+  |
|  | マニフェスト名         作成日時       最終更新日時  |  |
|  |----------------------------------------------------|  |
|  | 古今和歌集 巻一        2026-02-20     2026-02-25   |  |
|  | sample_document.pdf    2026-02-18     2026-02-18   |  |
|  | ...                                                |  |
|  +----------------------------------------------------+  |
+----------------------------------------------------------+
```

### 4.2 エディタ画面（旧 4 — 変更なし）

```
+------------------+----------------------------------+-------------------+
|                  |  ツールバー（描画モード切替・ズームリセット等）         |                   |
|  サムネイル      +----------------------------------+  アノテーション    |
|  一覧パネル      |                                  |  一覧パネル        |
|                  |                                  |                   |
|  [Canvas 1]      |     OpenSeadragon ビューア       |  [anno 1] テキスト |
|  [Canvas 2]  ◀  |     （画像 + アノテーション矩形） |  [anno 2] テキスト |
|  [Canvas 3]      |                                  |  ...               |
|  ...             |                                  +-------------------+
|                  |                                  |  テキスト編集エリア|
|                  +----------------------------------+  言語コード入力   |
|                  |  ← 前のページ  3 / 120  次のページ→ |  [保存] [削除]    |
+------------------+----------------------------------+-------------------+
```

---

## 5. 非機能要件

| 項目 | 内容 |
|------|------|
| 動作環境 | モダンブラウザ（Chrome / Firefox / Safari / Edge 最新版） |
| **[CHANGED]** 実行環境 | ~~静的ファイルのみで動作（SPA）~~ → Next.js サーバーが必要（静的エクスポート不可） |
| **[CHANGED]** オフライン対応 | ~~アプリ本体は静的配信で動作~~ → サーバー起動が必要なためオフライン動作は非対応 |
| **[NEW]** ファイルアップロード | アップロード可能なファイルタイプを MIME タイプで検証する。ファイルサイズの上限を設ける（要検討） |
| アクセシビリティ | キーボード操作による基本機能の利用 |
| レスポンシブ | デスクトップブラウザに最適化（タブレット以上推奨） |

---

## 6. 今後の検討事項

- 複数アノテーションが重なった場合の選択 UI の詳細仕様（現状：最新アノテーション優先）
- アノテーションの並べ替え（手動順序変更）の必要性
- キーボードショートカットの詳細仕様
- 一般公開時の `AnnotationPage` / `Annotation` `id` URI 設計
- **[NEW]** 実ファイルアップロード画像の Canvas サイズ（`width` / `height`）の自動取得方法
- **[NEW]** ストレージ容量管理（アップロード画像の蓄積に対する上限・自動削除ポリシー）
- **[NEW]** 実ファイルアップロード由来の manifest エクスポート時の画像 URI 外部公開対応
- TIFF 等の非対応形式をアップロードした場合のエラーメッセージ仕様

---

*最終更新: 2026-02-26（v0.3 — データ保存をサーバーサイドファイルシステムに変更、実ファイルアップロード機能追加、プロジェクト管理画面追加）*
